---
title: "Golden Rules for Reproducible Statistical Analyses"
author: "Amy Gimma and Thibaut Jombart"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: pygments
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_collapse: no
    toc_depth: 2
    toc_float: yes
    # css: !expr here::here('css', 'style.css')
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = TRUE,
                      fig.width = 8,
                      fig.height = 6,
                      dpi = 150,
                      warning = FALSE,
                      message = FALSE)
```

```{r read_scripts}

## read scripts
path_to_scripts <- here::here("scripts")

scripts_files <- dir(path_to_scripts, pattern = ".R$",
                     full.names = TRUE)
load_dictionary <- here::here("scripts", "load_dictionary.R")
for (file in scripts_files) if (!file == load_dictionary) source(file)

```


<!-- Rule 1 -->
# Write for your audience {.tabset .tabset-fade .tabset-pills}

* Make sure your report or exported data will be useful for your audience
* Know your audience's baseline understanding of the subject matter and statistical
methods, and annotate results as needed.
* All data manipulation, statistical methodology, results, etc should be clear 
without reading the code. Include formulas in the text when appropriate.

<!-- Rule 2 -->
# Organize your document and each section {.tabset .tabset-fade .tabset-pills}

* Structure the document in a way that will make the most sense to the reader
* Fully contain each step of the process into one section and use subsections 
to organize the code (aviod distributing the steps of an analysis to different
sections throughout the document)
* Start with the most general dataset with crude analyses before 
subsetted or stratified analyses

<!-- Rule 3 -->
# Prepare data first {.tabset .tabset-fade .tabset-pills}

## Overview

* **Data preparation includes creating new columns, manipulating data, and formatting,
corrections to spelling, dates, and formatting** Document all changes to the 
underlying data in a dedicated section before any analyses.
* Define, create, and describe all new and manipulated dataset columns before 
starting the analysis

## Example 

#### Add new variables

* `top_zones` which retains the top 7 health zones (with
most cases since the beginning of the outbreak), and pool everything else into
'others'.

* `top_zones_recent_report` which retains the top 7 health zones with 
the most cases in the past 21 days by or date of report.

* `top_zones_recent_onset` which retains the top 7 health zones with 
the most cases in the past 21 days by or date of report.

```{r eval = FALSE}

## Major health zones
## Defined for the entire outbreak, and for the last 21 days

recent_date <- database_date - 21
recent_report <- x$date_report >= recent_date
recent_onset <- x$date_onset >= recent_date

x <- x %>%
  mutate(top_zones = top_values(zone_de_sante, 6),
         top_zones_recent_report =
           top_values(zone_de_sante, 6, subset = recent_report),
         top_zones_recent_onset =
           top_values(zone_de_sante, 6, subset = recent_onset))


## force level order for transmission place
levels(x$transmission_place_group) <-  c("multiple", 
                                         "non_enregistre",
                                         "communautaire",
                                         "nosocomial")

## Community death
x <- x %>% mutate(community_death =
                    ifelse(type_death == "community", "oui", "non"),
                  community_death = factor(community_death,
                                           levels = c("oui", "non")))

## Force levels for contact status
x <- x %>% mutate(report_status =
                    factor(report_status,
                           levels = c("dead", "inconnu", "alive")))
                  

```


<!-- Rule 4 -->
# Follow standard naming conventions {.tabset .tabset-fade .tabset-pills}

Predictable naming helps streamline writing and reviewing code
* *column names* should be lower snake case in utf-8 format without any special
characters or acccents (ex: Use;  `Unité âge (mois, années)` )

<!-- Rule 5 -->
# Show uncertainty {.tabset .tabset-fade .tabset-pills}

## Overview
Confidence intervals should be used: 

* to represet the uncertainty around generalisability from sample to population
* to represent uncertainty and variable conditions in data collection
* on predictions and imputations



```

 -------------------------    |Yes|----- **Include Confidence Interval**
|                         |     |  
|     Might the value     |     |
| observed be different   |-----|
| with a larger sample?   |     |                 |Yes|--| **CI not required**
|                         |     |    -----------   |
 -------------------------    |No|--| You sure? |--|
                                     -----------   |
                                                  |No|-- **Ask a statistician!**
```

## Example

Let us make some toy data, and plot a trend **without showing dispersion** in
the data:

```{r example_uncertainty, fig.width = 4, fig.height = 4, fig.pos = "center"}

set.seed(1)
x <- rep(1:50, each = 15)
y <- rnorm(length(x), mean = 1)
df <- data.frame(x, y)

ggplot(df, aes(x = x, y = y)) +
  theme_bw() +
  geom_smooth() +
  labs(title = "Is there a trend here?")

```

Looking at this graph, **we may think there is a downward trend**, and start
interpreting what it means etc. Data have been generated in such a way that
there is no correlation between the two variables. This would be obvious if we
add the data, thereby representing the variability in the data:

```{r example_uncertainty_2, fig.width = 4, fig.height = 4, fig.pos = "center"}

ggplot(df, aes(x = x, y = y)) +
  theme_bw() +
  geom_point() +
  geom_smooth() +
  labs(title = "No, there is not!")

```




<!-- Rule 6 -->
# Code systematically {.tabset .tabset-fade .tabset-pills}

Be consistent in functions in libraries used

* *use `linelist::clean_data`* with a data dictionary for cleaning dates,
column names and values, etc. Take the time to understand how to use this 
package and how it works.

* for example choose between `n()`, `tally()`, and `count()` when summarizing 
grouped data

<!-- Rule 7 -->
# Always use relative paths {.tabset .tabset-fade .tabset-pills}

Absolute paths will not work when the code is run on other computers. Use the
`here` library with R project files to establish a root directory

```{r eval = FALSE}

# Use:
read.csv(here::here("/data/file_name.csv")

# NOT:
read.csv("P://user/specific/path/to/shared/directory/data/file_name.csv")

```

<!-- Rule 8 -->
# Version and archive documents {.tabset .tabset-fade .tabset-pills}

Use semantic versioning in a clearly organized, standardized file structure

```
.
+-- linelist_investigations
|   +-- css
|   +-- data
|   +-- report_outputs
|   +-- report_sources
|       +-- aaa_clean_linelist_2019-29-09.Rmd
|       +-- epicurve_2019-04-10.Rmd
|       +-- _archive
|           +-- epicurve_2019-23-09.Rmd
|           +-- epicurve_2019-12-09.Rmd

```

<!-- Rule 9 -->
# Use descriptive naming {.tabset .tabset-fade .tabset-pills}

Variables, functions, and data sets should be named in a way that describes the 
object

<!-- Rule 10 -->
# Prepare presentation-ready plots {.tabset .tabset-fade .tabset-pills}

**Plots should be ready to copy and paste into an official presentation**

* check labels for correct spelling, accents, and grammar 
* uniform colors for variables throughout a document
* text size large
* avoid overlapping labels or other features


<!-- Rule 11 -->
# Always have your code reviewed {.tabset .tabset-fade .tabset-pills}

Ensure that:

* Analysis is appropriate to setting and underlying data is well understood, 
local collaborators should be included and acknowledged
* statistical methodology is applied correctly
* R code is readable and correctly implements methodology 
* markdown and the report document are well organized and properly formatted

<!-- Rule 12 -->
# Keep data safe {.tabset .tabset-fade .tabset-pills}

* Respect the privacy of the individuals described in the data

* Never label data as anonomysed without complying with best practices of the
standards and methods of anonymyzation (and clear final product with a 
qualified statistician)
